{% extends 'base.html' %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header Section -->
    <div class="profile-header">
        <div class="columns is-vcentered">
            <!-- Profile Picture -->
            <div class="column is-3">
                <div class="profile-pic-container">
                    <figure class="image is-1by1">
                        {% if profile.picture %}
                        <img src="{{ profile.picture.url }}" class="is-rounded" alt="Profile picture">
                        {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&size=256" 
                             class="is-rounded" 
                             alt="{{ user.username }}'s profile picture">
                        {% endif %}
                    </figure>
                </div>
            </div>
            
            <!-- Profile Info -->
            <div class="column">
                <div class="profile-stats">
                    <div class="stats-count">{{ posts.count }}</div>
                    <div class="stats-label">Posts</div>
                </div>
                <div class="profile-stats">
                    <a href="{% url 'followers' user.username %}">
                        <div class="stats-count">{{ follower_count }}</div>
                        <div class="stats-label">Followers</div>
                    </a>
                </div>
                <div class="profile-stats">
                    <a href="{% url 'following' user.username %}">
                        <div class="stats-count">{{ following_count }}</div>
                        <div class="stats-label">Following</div>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Profile Details -->
        <div class="profile-details">
            <h1 class="title is-4">@{{ user.username }}</h1>
            {% if profile.first_name or profile.last_name %}
            <p class="profile-name">{{ profile.first_name }} {{ profile.last_name }}</p>
            {% endif %}
            {% if profile.profile_info %}
            <p class="profile-bio">{{ profile.profile_info }}</p>
            {% endif %}

            {% if request.user != user %}
<a href="{% url 'inbox' %}?active_direct={{ user.username }}" class="button is-link is-small">
    <span class="icon">
        <i class="fas fa-paper-plane"></i>
    </span>
    <span>Message</span>
</a>
{% endif %}
            
            <!-- Profile Actions -->
            <div class="profile-actions">
                {% if request.user == user %}
                <a href="{% url 'edit-profile' %}" class="button is-light is-small">Edit Profile</a>
                {% else %}
                    {% if is_following %}
                    <form method="post" action="{% url 'follow' user.username 0 %}">
                        {% csrf_token %}
                        <button type="submit" class="button is-light is-small">Following</button>
                    </form>
                    {% else %}
                    <form method="post" action="{% url 'follow' user.username 1 %}">
                        {% csrf_token %}
                        <button type="submit" class="button is-primary is-small">Follow</button>
                    </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Profile Tabs -->
    <div class="tabs is-centered is-toggle is-fullwidth">
        <ul>
            <li class="{% if active_tab == 'posts' %}is-active{% endif %}">
                <a href="{% url 'profile' user.username %}">
                    <span class="icon is-small"><i class="fas fa-th"></i></span>
                    <span>Posts</span>
                </a>
            </li>
            <li class="{% if active_tab == 'saved' %}is-active{% endif %}">
                <a href="{% url 'favorites_lists' %}">
                    <span class="icon is-small"><i class="fas fa-bookmark"></i></span>
                    <span>Saved</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Posts Grid -->
    <div class="posts-grid">
        {% if posts %}
        <div class="columns is-multiline is-mobile">
            {% for post in posts %}
            <div class="column is-one-third-desktop is-half-tablet is-half-mobile">
                <div class="post-thumbnail">
                    <a href="{% url 'post_details' post.id %}">
                       <figure class="image is-1by1">
    {% for content in post.content.all %}
        {% if content.content_type == 'image' %}
        <img src="{{ content.file.url }}" 
             alt="{{ post.caption|truncatechars:30 }}"
             class="post-image">
        {% elif content.content_type == 'video' %}
        <video class="post-image" controls>
            <source src="{{ content.file.url }}" type="video/mp4">
        </video>
        {% endif %}
    {% empty %}
    <img src="https://bulma.io/images/placeholders/640x480.png" 
         alt="Default post image"
         class="post-image">
    {% endfor %}
    
    <div class="post-overlay">
        <span class="icon-text">
            <span class="icon">
                <i class="fas fa-heart"></i>
            </span>
            <span>{{ post.likes }}</span>
        </span>
        <span class="icon-text ml-3">
            <span class="icon">
                <i class="fas fa-comment"></i>
            </span>
            <span>{{ post.comments.count }}</span>
        </span>
    </div>
</figure>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-posts">
            <div class="notification is-light">
                <p class="mb-3">No posts yet</p>
                {% if request.user == user %}
                <a href="{% url 'new_post' %}" class="button is-primary is-small">Create your first post</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.profile-container {
    max-width: 935px;
    margin: 0 auto;
    padding: 30px 20px 0;
}

.profile-header {
    margin-bottom: 44px;
}

.profile-pic-container {
    max-width: 150px;
    margin: 0 auto;
}

.profile-pic-container .image {
    border-radius: 50%;
    overflow: hidden;
    border: 1px solid #efefef;
}

.profile-stats {
    display: inline-block;
    text-align: center;
    margin-right: 40px;
}

.stats-count {
    font-size: 1.5rem;
    font-weight: 600;
}

.stats-label {
    font-size: 0.9rem;
}

.profile-details {
    margin-top: 20px;
}

.profile-bio {
    margin: 10px 0;
    line-height: 1.5;
}

.profile-actions {
    margin-top: 15px;
}

.profile-actions form {
    display: inline-block;
    margin-right: 10px;
}

.tabs {
    margin: 0 0 30px;
    border-bottom: 1px solid #efefef;
}

.posts-grid {
    margin: -5px;
}

.post-thumbnail {
    margin: 5px;
    position: relative;
}

.post-image {
    object-fit: cover;
}

.post-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.post-thumbnail:hover .post-overlay {
    opacity: 1;
}

.no-posts {
    padding: 60px 0;
    text-align: center;
}

@media screen and (max-width: 768px) {
    .profile-header .columns {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-stats {
        margin: 0 20px;
    }
    
    .profile-details {
        text-align: center;
    }
}
</style>
{% endblock %}